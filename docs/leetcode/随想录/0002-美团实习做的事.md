# 2-美团太平洋系统

## 1.整体业务

​      我们部门是做B端的业务，**架构比较复杂**。整体的业务是 做的 叫**太平洋系统**，为美团**客服**服务。我们做的是其中的一个核心业务，**工单系统**。工单就像一个**问题追踪器**，通过用户打电话、在线进线，客服会为**用户的问题**反馈，**建立工单**，通过工单可以能够清晰地进行**问题追踪、处理和归**档，标准化服务的根据过程。



## 2.工单系统架构

​	工单系统主要分为**配置台**和**运行时**，配置台是提供一些**功能**或者**页面配置**，可以动态配置工单问题、按钮、页面、工单流程、状态等，是**运营侧**在管理。**运行时**是客服使用，根据**配置台的配置**，动态建立工单、进行工单的**流转**和**处理**。

​	 业务流程主要是客服**接听电话**或者**在线坐席**在线接收到用户反馈，客服会根据反馈的问题先給一个初步的**一二级分类**，如用户问题，外卖问题，这两级问题也成为**一二级FAQ**。客服可以通过这两级问题进入一个**弹屏页面**，通过**搜索手机号**获取订单信息。客服可以通过搜索配置台配置的**工单类型**，选择对应的**具体问题**对应的**工单类型**。工单类型下绑定了一个具体的**六级FAQ问题**，比如外卖超时等问题，并且在配置台配置了相应的**工单的创建页**以及**详情页面**，还有工单的**流程配置**信息等，流程配置是工单的状态机，需要以怎样的流程驱动工单直至结案。流程通过**流程节点定义**，节点就是工单的**实时状态**，比如一线处理中，申请赔付中，已结案等。客服可以通过配置的按钮和动作进行一些节点的流转，最终将工单结案。

## 3.数据流

​		**数据对象**：在工单页面中，数据流是通过统一的防腐层来管理，叫做**数据对象**，数据对象是**太平洋系统**承载信息的载体，与真实的**业务数据**映射。可以通过配置台配置，在创建工单时，通过**数据对象**记录和**展示业务信息**。数据对象其实实质上就是定义的一个RPC获取真实业务数据的工具。

​		**扩展字段**：在建立工单时，会有一些配置的**扩展字段**，扩展字段是由一些前端页面组件组成，承载不同工单的**业务数据**。比如一些表单，备注信息等，主要是携带工单创建的一些**业务信息**，供后续业务逻辑使用。



## 4.实习做的事情

负责工单系统中对外RPC接口的编写，如工单扩展字段、数据对象等功能的CRUD接口。

负责修复一些线上问题的修复，如NPE，监控埋点覆盖等。

负责一些小工具的开发。如工单侧数据对象换绑查询工具等。

完成工单侧架构梳理，B端的设计架构、工单建单流程等文档梳理

独立完成工单系统扩展字段变更统计需求的设计文档、代码编写、单测和上线。

实习收获：在不熟悉JAVA后端的情况下，熟悉了企业JAVA后端开发流程，对真实的业务需求有了更加深入的认识，了解了美团工单业务架构。

## 5.做的需求 - 工单扩展字段变更统计

​       在工单系统中，每个工单可以关联**一个或多个扩展字段**，这些字段包括**文本框、选择器、表格**等特定组件。在工单处理过程中，扩展字段可能会随着**工单的流转发生变更**，需要**自动统计指定字段在指定时间**的变更次数及**其变更前后的内容**。独立完成了该需求的设计文档、代码编写、单测和上线。

技术栈：Spring Boot、Mybatis、Squirrel(Redis)、Mafka(Kafka)、Cerberus

- **配置台：**
  - 允许增删指定的统计字段，统计字段的ID保存在缓存中以便快速查询。
  - 通过数据订阅统计字段表的Binlog，并使用Mafka生产者发送Binlog消息。
  - 在另一个服务中消费消息并存入缓存，实现数据库与缓存的同步。
- **运行态：**
  - 通过定时任务自动统计变更记录，提供详细变更查询接口。可以根据日期、字段名称或ID查询对应字段的变更次数。
  - 订阅工单字段表的Binlog，通过Mafka消费Binlog消息统计变更内容，通过缓存快速判断是否为需要统计的字段。
  - 使用Cerberus解决统计字段变更记录并发安全问题。根据字段ID和日期作为key，锁住对应的行记录，完成字段变更的统计。



需求项目收获：了解了真实业务需求和代码规范问题。更加了解了数据一致性问题，以及MQ以及分布式锁的使用场景。